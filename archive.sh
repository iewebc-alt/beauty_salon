#!/bin/bash

# ==============================================================================
#           УМНЫЙ СКРИПТ ДЛЯ АРХИВАЦИИ И ВОССТАНОВЛЕНИЯ ПРОЕКТА
# ==============================================================================
#
# Режимы работы:
#   ./archive.sh backup     - Автоматически сканирует проект и создает
#                             самораспаковывающийся архив.
#
# Для восстановления просто запустите созданный бэкап-файл: ./salon_backup_...sh
#
# ==============================================================================

# --- НАСТРОЙКИ ---
# Шаблон имени для финального самораспаковывающегося скрипта
OUTPUT_ARCHIVE_NAME="salon_backup_$(date +%Y%m%d_%H%M%S).sh"
TEMP_TAR_FILE="project_content.tar.gz"

# Список исключений. Все файлы и папки, соответствующие этим шаблонам,
# будут проигнорированы.
EXCLUDE_LIST=(
    "venv"
    "__pycache__"
    ".pytest_cache"
    "*.pyc"
    "*.log"
    "*.sh" 
    "*.tar.gz" # <-- ГЛАВНОЕ ИСПРАВЛЕНИЕ: Исключаем все .tar.gz
    ".git"
    ".idea"
    "tests"
    "project_dump.txt"
)


# --- ФУНКЦИЯ РЕЖИМА: BACKUP ---
do_backup() {
    echo ">>> Сканирую проект и создаю архив..."

    # Формируем аргументы --exclude для команды tar
    local tar_excludes=()
    for item in "${EXCLUDE_LIST[@]}"; do
        tar_excludes+=(--exclude="$item")
    done

    # Создаем tar.gz архив, включая все в текущей директории (.),
    # но применяя список исключений. Подавляем предупреждение о измененных файлах.
    tar --warning=no-file-changed "${tar_excludes[@]}" -czf "$TEMP_TAR_FILE" .
    
    local exit_code=$?
    if [ $exit_code -gt 1 ]; then
        echo "!!! Ошибка: Не удалось создать tar архив. Прерывание."
        rm -f "$TEMP_TAR_FILE"
        exit 1
    fi
    
    if [ ! -s "$TEMP_TAR_FILE" ]; then
        echo "!!! Ошибка: Созданный архив пуст. Проверьте список исключений."
        rm -f "$TEMP_TAR_FILE"
        exit 1
    fi

    echo ">>> Временный архив '$TEMP_TAR_FILE' успешно создан."

    # Создаем "голову" скрипта - часть, которая будет выполнять распаковку
    cat << 'EOF' > "$OUTPUT_ARCHIVE_NAME"
#!/bin/bash

# Это самораспаковывающийся архив.
# Для восстановления просто запустите этот скрипт в пустой папке.

echo ">>> Обнаружен самораспаковывающийся архив."
read -p ">>> ВНИМАНИЕ! Это действие распакует файлы проекта в текущий каталог. Продолжить? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ">>> Восстановление отменено."
    exit 1
fi

# Находим строку, где начинается архив (маркер __ARCHIVE_BELOW__)
SKIP=$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' "$0")

# Используем tail, чтобы извлечь все, что находится ПОСЛЕ маркера,
# и передаем это напрямую в tar для распаковки
echo ">>> Начинаю распаковку..."
tail -n +$SKIP "$0" | tar -xzf -

if [ $? -eq 0 ]; then
    echo ">>> Проект успешно восстановлен в текущем каталоге."
else
    echo "!!! Ошибка: Не удалось распаковать архив."
fi

exit 0

# НЕ РЕДАКТИРУЙТЕ И НЕ УДАЛЯЙТЕ СТРОКУ НИЖЕ
__ARCHIVE_BELOW__
EOF

    # "Приклеиваем" бинарные данные архива к "голове" скрипта
    cat "$TEMP_TAR_FILE" >> "$OUTPUT_ARCHIVE_NAME"
    echo ">>> Архив '$TEMP_TAR_FILE' добавлен в скрипт '$OUTPUT_ARCHIVE_NAME'."

    # Делаем финальный скрипт исполняемым
    chmod +x "$OUTPUT_ARCHIVE_NAME"
    echo ">>> Скрипту '$OUTPUT_ARCHIVE_NAME' предоставлены права на исполнение."

    # Удаляем временный файл
    rm "$TEMP_TAR_FILE"
    echo ">>> Временный файл удален."

    echo -e "\n>>> ГОТОВО! Ваш бэкап сохранен в файле: $OUTPUT_ARCHIVE_NAME"
}


# --- ГЛАВНАЯ ЛОГИКА ---
if [ "$1" == "backup" ]; then
    do_backup
else
    echo ">>> Неверный режим. Используйте 'backup' для создания архива."
    echo ">>> Пример: ./archive.sh backup"
    exit 1
fi

exit 0
