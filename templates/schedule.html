{% extends "base.html" %}

{% block head %}
<style>
    .schedule-grid { display: flex; overflow-x: auto; padding-bottom: 20px;}
    .master-col { min-width: 300px; background: white; margin-right: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
    .master-header { background: #343a40; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; }
    .slots-container { padding: 10px; min-height: 500px; position: relative; }
    .master-col:hover .add-btn-overlay { opacity: 1; }
    .add-btn-overlay { opacity: 0; transition: 0.2s; position: absolute; top: 10px; right: 10px; }
    .appt-card { cursor: pointer; transition: transform 0.1s; }
    .appt-card:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm" style="max-width: 900px; margin: 0 auto;">
    <a href="?selected_date_str={{ prev_date }}" class="btn btn-outline-secondary">‚Üê</a>
    <div class="text-center mx-4">
        <h3 class="mb-0">{{ selected_date.strftime('%d.%m.%Y') }}</h3>
        <small class="text-muted">{{ selected_date.strftime('%A') }}</small>
    </div>
    <a href="?selected_date_str={{ next_date }}" class="btn btn-outline-primary">‚Üí</a>
    <button class="btn btn-success ms-4" onclick="openModal()">‚ûï –ó–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
</div>

<div class="schedule-grid px-3">
    {% for master in masters %}
    <div class="master-col">
        <div class="master-header">
            <h5 class="mb-0">{{ master.name }}</h5>
            <small style="color: #adb5bd;">{{ master.specialization }}</small>
        </div>
        <div class="slots-container bg-light">
            <button class="btn btn-sm btn-primary add-btn-overlay rounded-circle shadow" onclick="openModal(null, {{ master.id }})" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å">+</button>
            {% set ns = namespace(found=false) %}
            {% for appt in appointments %}
                {% if appt.master_id == master.id %}
                    {% set ns.found = true %}
                    <div class="card mb-2 shadow-sm border-0 appt-card" onclick="editAppt({{ appt.id }}, {{ appt.client_id }}, {{ appt.service_id }}, {{ appt.master_id }}, '{{ appt.start_time.strftime('%Y-%m-%dT%H:%M') }}')">
                        <div class="card-body p-2 border-start border-4 border-primary">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="badge bg-primary">{{ appt.start_time.strftime('%H:%M') }}</span>
                            </div>
                            <div class="fw-bold text-truncate">{{ appt.client.name }}</div>
                            <div class="small text-muted text-truncate">{{ appt.service.name }}</div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            {% if not ns.found %}
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted mt-5">
                    <span style="font-size: 2em; opacity: 0.1;">üìÖ</span>
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="apptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="apptForm" onsubmit="saveAppt(event)">
                    <input type="hidden" id="apptId">
                    <div class="mb-3">
                        <label class="form-label">–ö–ª–∏–µ–Ω—Ç</label>
                        <div class="input-group">
                            <select id="clientId" class="form-select" required>
                                <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞...</option>
                                {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.name }} ({{ client.phone_number }})</option>
                                {% endfor %}
                            </select>
                            <a href="/admin/clients" class="btn btn-outline-secondary">üë§+</a>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-7">
                            <label class="form-label">–î–∞—Ç–∞ –∏ –í—Ä–µ–º—è</label>
                            <input type="datetime-local" id="startTime" class="form-control" required>
                        </div>
                        <div class="col-5">
                            <label class="form-label">–ú–∞—Å—Ç–µ—Ä</label>
                            <select id="masterId" class="form-select" required>
                                {% for master in masters %}
                                    <option value="{{ master.id }}">{{ master.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">–£—Å–ª—É–≥–∞</label>
                        <select id="serviceId" class="form-select" required>
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }} ({{ service.duration_minutes }} –º–∏–Ω - {{ service.price }}—Ä)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" id="deleteBtn" class="btn btn-danger" style="display: none;" onclick="deleteCurrentAppt()">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modal = new bootstrap.Modal(document.getElementById('apptModal'));

    function openModal(dateStr = null, masterId = null) {
        document.getElementById('apptForm').reset();
        document.getElementById('apptId').value = '';
        document.getElementById('modalTitle').innerText = '‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å';
        document.getElementById('deleteBtn').style.display = 'none';
        if (masterId) document.getElementById('masterId').value = masterId;
        let defaultDate = '{{ selected_date.strftime("%Y-%m-%d") }}T10:00';
        document.getElementById('startTime').value = defaultDate;
        modal.show();
    }

    function editAppt(id, clientId, serviceId, masterId, startTimeIso) {
        document.getElementById('apptId').value = id;
        document.getElementById('clientId').value = clientId;
        document.getElementById('serviceId').value = serviceId;
        document.getElementById('masterId').value = masterId;
        document.getElementById('startTime').value = startTimeIso;
        document.getElementById('modalTitle').innerText = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏';
        document.getElementById('deleteBtn').style.display = 'block';
        modal.show();
    }

    async function saveAppt(event) {
        event.preventDefault();
        const id = document.getElementById('apptId').value;
        const data = {
            client_id: parseInt(document.getElementById('clientId').value),
            master_id: parseInt(document.getElementById('masterId').value),
            service_id: parseInt(document.getElementById('serviceId').value),
            start_time: document.getElementById('startTime').value
        };
        let url = '/api/v1/appointments/admin';
        let method = 'POST';
        if (id) {
            url = `/api/v1/appointments/${id}`;
            method = 'PUT';
        }
        const res = await apiRequest(url, method, data);
        if (res) location.reload();
    }

    async function deleteCurrentAppt() {
        const id = document.getElementById('apptId').value;
        if (!id) return;
        if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
            const res = await apiRequest(`/api/v1/appointments/${id}`, 'DELETE');
            if (res) location.reload();
        }
    }
</script>
{% endblock %}
EOF
