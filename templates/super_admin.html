<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SuperAdmin | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .step-circle { 
            width: 24px; height: 24px; background: #0d6efd; color: white; 
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; 
            font-size: 12px; margin-right: 8px; 
        }
        .code-block {
            background: #212529; color: #00ff9d; padding: 10px; border-radius: 6px; 
            font-family: monospace; cursor: pointer; position: relative;
        }
        .code-block:hover::after {
            content: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"; position: absolute; right: 10px; top: 50%; 
            transform: translateY(-50%); color: white; font-size: 10px;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2 class="fw-bold text-primary">üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∞–ª–æ–Ω–∞–º–∏</h2>
            <button class="btn btn-success btn-lg shadow-sm" onclick="openModal()">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–∞–ª–æ–Ω</button>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>–ë–æ—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–í—Ö–æ–¥</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for salon in salons %}
                        <tr>
                            <td class="ps-4 text-muted">#{{ salon.id }}</td>
                            <td class="fw-bold">{{ salon.title or salon.name }}</td>
                            <td><code class="bg-light px-2 py-1 rounded">{{ salon.name }}</code></td>
                            <td>
                                <span class="badge bg-secondary">–°–∫—Ä—ã—Ç</span>
                            </td>
                            <td>
                                {% if salon.is_active %}
                                    <span class="badge bg-success rounded-pill">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                {% else %}
                                    <span class="badge bg-danger rounded-pill">–û—Ç–∫–ª—é—á–µ–Ω</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/admin/schedule" target="_blank" class="btn btn-sm btn-outline-primary" title="–í–æ–π—Ç–∏">
                                    –ê–¥–º–∏–Ω–∫–∞ ‚ÜóÔ∏è
                                </a>
                                <div class="small text-muted mt-1">Pass: {{ salon.admin_password }}</div>
                            </td>
                            <td class="pe-4 text-end">
                                <button class="btn btn-sm btn-light border" onclick="editSalon({{ salon.id }}, '{{ salon.name }}', '{{ salon.telegram_token }}', '{{ salon.admin_password }}', {{ 'true' if salon.is_active else 'false' }}, '{{ salon.title or '' }}')">
                                    ‚öôÔ∏è
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal fade" id="salonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">–ù–æ–≤—ã–π —Å–∞–ª–æ–Ω</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <form id="salonForm" onsubmit="saveSalon(event)">
                        <input type="hidden" id="salonId">
                        
                        <!-- –®–ê–ì 1: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                        <h6 class="mb-3"><span class="step-circle">1</span>–î–∞–Ω–Ω—ã–µ –æ —Å–∞–ª–æ–Ω–µ</h6>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (–†—É—Å—Å–∫–∏–π)</label>
                                <input type="text" id="title" name="title" class="form-control" placeholder="–°–∞–ª–æ–Ω '–†–æ–º–∞—à–∫–∞'" oninput="generateData(this.value)" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–õ–æ–≥–∏–Ω (–°–∏—Å—Ç–µ–º–Ω—ã–π)</label>
                                <input type="text" id="name" name="name" class="form-control bg-light" readonly required>
                            </div>
                        </div>

                        <!-- –®–ê–ì 2: Telegram –ë–æ—Ç -->
                        <h6 class="mb-3"><span class="step-circle">2</span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram</h6>
                        <div class="alert alert-light border mb-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="small text-muted">–ú—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ "Username taken".</span>
                                <a href="https://t.me/BotFather" target="_blank" class="btn btn-sm btn-outline-info">–û—Ç–∫—Ä—ã—Ç—å @BotFather ‚ÜóÔ∏è</a>
                            </div>
                            
                            <div class="mb-2">
                                <small>1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É (—Å–æ–∑–¥–∞—Å—Ç –±–æ—Ç–∞):</small>
                                <div class="code-block" onclick="copyToClipboard('/newbot')">/newbot</div>
                            </div>
                            <div class="mb-2">
                                <small>2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º—è (–Ω–∞–∑–≤–∞–Ω–∏–µ):</small>
                                <div class="code-block" id="botNamePreview" onclick="copyText(this)">–°–∞–ª–æ–Ω ...</div>
                            </div>
                            <div class="mb-2">
                                <small>3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π):</small>
                                <div class="code-block" id="botUserPreview" onclick="copyText(this)">salon_..._bot</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-success">–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π HTTP API Token:</label>
                            <input type="text" id="token" name="token" class="form-control form-control-lg border-success" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7823...:AAF..." required>
                        </div>

                        <!-- –®–ê–ì 3: –ü–∞—Ä–æ–ª—å -->
                        <h6 class="mb-3"><span class="step-circle">3</span>–î–æ—Å—Ç—É–ø—ã</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞</label>
                                <input type="text" id="password" name="password" class="form-control" value="admin" required>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" id="isActive" checked>
                                    <label class="form-check-label">–°–∞–ª–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω</label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const modal = new bootstrap.Modal(document.getElementById('salonModal'));

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ –∏ –∏–º–µ–Ω –¥–ª—è –±–æ—Ç–∞
        function generateData(text) {
            if (document.getElementById('salonId').value) return; // –ù–µ –º–µ–Ω—è—Ç—å –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

            const ru = {'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z','–∏':'i','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'c','—á':'ch','—à':'sh','—â':'sch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya',' ':'_'};
            
            let n_str = [];
            let lowerText = text.toLowerCase();
            for ( let i = 0; i < lowerText.length; i++ ) {
                let char = lowerText[i];
                if (ru[char] !== undefined) n_str.push(ru[char]);
                else if (/[a-z0-9]/.test(char)) n_str.push(char);
                else if (char === ' ') n_str.push('_');
            }
            const cleanName = n_str.join('');
            
            // 1. –õ–æ–≥–∏–Ω —Å–∏—Å—Ç–µ–º—ã
            document.getElementById('name').value = 'salon_' + cleanName;

            // 2. –ò–º—è –±–æ—Ç–∞ (–¥–ª—è –ª—é–¥–µ–π)
            document.getElementById('botNamePreview').innerText = text;

            // 3. –Æ–∑–µ—Ä–Ω–µ–π–º –±–æ—Ç–∞ (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π! –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–¥–æ–º)
            const randomId = Math.floor(Math.random() * 1000);
            document.getElementById('botUserPreview').innerText = `${cleanName}_${randomId}_bot`;
        }

        function copyText(element) {
            navigator.clipboard.writeText(element.innerText);
            const original = element.innerText;
            element.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
            setTimeout(() => element.innerText = original, 1000);
        }
        function copyToClipboard(text) {
             navigator.clipboard.writeText(text);
        }

        async function apiRequest(url, method, body) {
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if (response.ok) location.reload();
            else {
                const err = await response.json();
                alert("–û—à–∏–±–∫–∞: " + (err.detail || response.statusText));
            }
        }

        function openModal() {
            document.getElementById('salonId').value = '';
            document.getElementById('salonForm').reset();
            document.getElementById('modalTitle').innerText = '–ù–æ–≤—ã–π —Å–∞–ª–æ–Ω';
            document.getElementById('name').readOnly = true;
            modal.show();
        }

        function editSalon(id, name, token, password, isActive, title) {
            document.getElementById('salonId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('title').value = title;
            document.getElementById('token').value = token;
            document.getElementById('password').value = password;
            document.getElementById('isActive').checked = isActive;
            
            document.getElementById('modalTitle').innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–ª–æ–Ω–∞';
            modal.show();
        }

        async function saveSalon(e) {
            e.preventDefault();
            const id = document.getElementById('salonId').value;
            const formData = new FormData(e.target);
            
            if (id) {
                const data = {
                    name: formData.get('name'),
                    telegram_token: formData.get('token'),
                    admin_password: formData.get('password'),
                    is_active: document.getElementById('isActive').checked
                };
                await apiRequest(`/superadmin/salons/${id}`, 'PUT', data);
            } else {
                await fetch('/superadmin/salons', {method:'POST', body: formData}).then(async res => {
                    const data = await res.json();
                    if(res.ok) {
                        alert(data.message || "–°–∞–ª–æ–Ω —Å–æ–∑–¥–∞–Ω! –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...");
                        location.reload();
                    } else alert(data.detail || "–û—à–∏–±–∫–∞");
                });
            }
        }
    </script>
</body>
</html>
